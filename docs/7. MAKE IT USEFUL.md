# Plan: PDF â†’ Topics â†’ Learnings â†’ Flashcards Pipeline

## Goal

Build a unified pipeline where PDFs flow through Topics (structural chunking) into Learnings (knowledge units), which power a learning-science-informed flashcard system.

```
Conversations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Learnings â”€â”€â–º Flashcards
                                            â–²
PDFs â”€â”€â–º Topics (intermediate chunks) â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 1: Schema Changes

### New Learning Schema

```typescript
Learning {
  learningId: string
  title: string
  problemSpace: string        // "When/why does this matter?"
  insight: string             // Core takeaway

  blocks: ContentBlock[]      // 0-N flashcard-ready Q&A pairs

  // Polymorphic source tracking
  sourceType: 'conversation' | 'topic'
  sourceId: string            // conversationUuid or topicId

  embedding: Buffer
  createdAt: Date
}

ContentBlock {
  blockType: 'qa' | 'why' | 'contrast'
  question: string
  answer: string
}
```

**Block types:**

- `qa` - Default. Covers definitions, proofs, formulas, examples, procedures
- `why` - Elaborative interrogation ("Why is X true?")
- `contrast` - Comparisons ("How does X differ from Y?")

### Database Migration

```sql
ALTER TABLE learnings ADD COLUMN problem_space TEXT NOT NULL;
ALTER TABLE learnings ADD COLUMN blocks TEXT NOT NULL;  -- JSON array
ALTER TABLE learnings ADD COLUMN source_type TEXT NOT NULL CHECK(source_type IN ('conversation', 'topic'));
ALTER TABLE learnings ADD COLUMN source_id TEXT NOT NULL;

-- Drop old columns
ALTER TABLE learnings DROP COLUMN trigger;
ALTER TABLE learnings DROP COLUMN why_points;
ALTER TABLE learnings DROP COLUMN faq;
ALTER TABLE learnings DROP COLUMN conversation_uuid;
```

---

## Part 2: Files to Modify

### Core Types

- `src/core/types.ts` - Update Learning, ContentBlock, LearningExtractor interfaces

### Database

- `src/db/schema.ts` - Update learnings table schema
- `migrations/0004_learning_schema_v2.sql` - Migration

### Schemas (Zod)

- `src/schemas/learning.ts` - Update to match new structure

### Services

- `src/services/learning-extractor.ts` - Update for new schema
- **NEW:** `src/services/topic-to-learning-extractor.ts` - Extract learnings from topics

### CLI

- `src/cli/extract-learnings.ts` - Update for new schema
- **NEW:** `src/cli/extract-learnings-from-topics.ts` - Topic â†’ Learning CLI

### API

- `src/api/learnings.ts` - Update queries for new schema
- `server/index.ts` - Update endpoints

### UI Components

- `client/src/App.tsx` - Add session-based flashcard flow
- `client/src/components/FlashcardsView.tsx` - Complete rewrite for session model
- `client/src/components/Flashcard.tsx` - Update for blocks
- **NEW:** `client/src/components/SessionComplete.tsx` - Session summary + synthesis

---

## Part 3: Implementation Phases

### Phase 1: Schema & Types

1. Update `src/core/types.ts` with new Learning interface
2. Update `src/schemas/learning.ts` Zod schema
3. Update `src/db/schema.ts` Drizzle schema
4. Create migration `migrations/0004_learning_schema_v2.sql`
5. Run migration, verify with sqlite3

### Phase 2: Topic â†’ Learning Extractor

1. Create `src/services/topic-to-learning-extractor.ts`
2. Update `src/factories/index.ts` with factory function
3. Create/update extraction prompt in Langfuse (with hardcoded fallback)
4. Write tests

### Phase 3: CLI Commands

1. Create `src/cli/extract-learnings-from-topics.ts`
2. Update `src/cli/extract-learnings.ts` for new schema
3. Test both pipelines end-to-end

### Phase 4: API Updates

1. Update `src/api/learnings.ts` for new schema
2. Add endpoint for session-based card fetching
3. Update `server/index.ts`

### Phase 5: Flashcard UI (Learning Science Design)

1. Rewrite `FlashcardsView.tsx` with session model
2. Update `Flashcard.tsx` for block rendering
3. Create `SessionComplete.tsx` with synthesis prompt
4. Style and polish

---

## Part 4: Flashcard UI Design (Learning Science)

### Session Flow

```
1. QUEUE BUILDING
   - Select N learnings (random or spaced repetition)
   - Collect all blocks, interleave across learnings

2. MAIN INSIGHT CARDS (one per learning)
   - Show problemSpace as context
   - "What's the core insight?"
   - User recalls â†’ reveals â†’ rates

3. BLOCK CARDS (interleaved)
   - All blocks shuffled together
   - question â†’ attempt â†’ reveal â†’ rate
   - Interleaving happens naturally

4. SESSION SUMMARY
   - Learnings covered
   - Synthesis prompt (no answer - pure generation)
```

### Key Learning Science Principles

| Principle                | Implementation                   |
| ------------------------ | -------------------------------- |
| **Retrieval Practice**   | Must tap "Show Answer"           |
| **Desirable Difficulty** | Self-rating after reveal         |
| **Interleaving**         | Blocks shuffled across learnings |
| **Elaboration**          | `why` blocks force explanation   |
| **Generation**           | Synthesis prompt at end          |
| **Feedback**             | Immediate reveal after attempt   |

### UI Wireframes

#### Home Screen

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLASHCARDS                             â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ðŸ“š Due for Review: 12 cards    â”‚   â”‚
â”‚  â”‚  [Start Review]                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ¨ Learn New: 3 learnings      â”‚   â”‚
â”‚  â”‚  [Start Learning]               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ðŸŽ¯ Quick Quiz: 10 random       â”‚   â”‚
â”‚  â”‚  [Start Quiz]                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Card View (Question)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [why]                    3 of 24       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  vNM Expected Utility                   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚  Why is the independence        â”‚   â”‚
â”‚  â”‚  axiom crucial?                 â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  [Show Answer]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Card View (Answer Revealed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [why]                    3 of 24       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  vNM Expected Utility                   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Why is the independence        â”‚   â”‚
â”‚  â”‚  axiom crucial?                 â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚  â”‚  Without independence, you      â”‚   â”‚
â”‚  â”‚  can't decompose compound       â”‚   â”‚
â”‚  â”‚  lotteries. It lets you         â”‚   â”‚
â”‚  â”‚  evaluate each outcome          â”‚   â”‚
â”‚  â”‚  separately and sum up.         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  [Forgot]    [Hard]    [Good]    [Easy] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Session Complete

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SESSION COMPLETE                       â”‚
â”‚                                         â”‚
â”‚  âœ“ 24 cards reviewed                    â”‚
â”‚                                         â”‚
â”‚  Learnings covered:                     â”‚
â”‚  â€¢ vNM Expected Utility                 â”‚
â”‚  â€¢ CRRA Utility                         â”‚
â”‚  â€¢ Allais Paradox                       â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  ðŸ§  SYNTHESIS CHALLENGE                 â”‚
â”‚                                         â”‚
â”‚  How does CRRA utility relate to        â”‚
â”‚  the critiques in Rabin's paradox?      â”‚
â”‚                                         â”‚
â”‚  (Just think - no answer needed)        â”‚
â”‚                                         â”‚
â”‚  [Done]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 5: Extraction Prompt

### Topic â†’ Learning Prompt

```
You are extracting flashcard-ready learnings from academic content.

TOPIC: {title}
SUMMARY: {summary}
KEY POINTS: {keyPoints}
SOURCE PASSAGES: {sourcePassages}

Extract learnings for exam preparation. Each learning should have:

1. **title**: Specific, memorable title
2. **problemSpace**: "When/why would you need this?" - the situation that makes this relevant
3. **insight**: Core realization in 1-2 sentences
4. **blocks**: Array of Q&A pairs (aim for 5-15), each with:
   - blockType: 'qa' | 'why' | 'contrast'
   - question: Front of flashcard
   - answer: Back of flashcard

Guidelines:
- Proof outlines as single Q&A ("What's the proof of X?" â†’ numbered steps with intuitions)
- Include "why" questions for deeper understanding
- Include contrasts with related concepts
- Include formulas/definitions as Q&A
- Be thorough - more blocks is better for exam prep

Return JSON array of learnings.
```

---

## Part 6: Gold Example

```json
{
  "title": "vNM Expected Utility: Why Rationality Implies EU Maximization",
  "problemSpace": "When modeling how rational agents choose between risky options",
  "insight": "If preferences satisfy 5 axioms (completeness, transitivity, continuity, independence, dominance), choices can be represented as maximizing expected utility",
  "blocks": [
    {
      "blockType": "qa",
      "question": "What are the 5 vNM axioms?",
      "answer": "1. Completeness (can compare any lotteries)\n2. Transitivity (consistent ordering)\n3. Continuity (no infinite preferences)\n4. Independence (common mixtures don't affect preference)\n5. Dominance (better probabilities = better lottery)"
    },
    {
      "blockType": "why",
      "question": "Why is the independence axiom crucial?",
      "answer": "Without independence, you can't decompose compound lotteries. It lets you evaluate each outcome separately and sum up - making utility additive over probabilities."
    },
    {
      "blockType": "qa",
      "question": "What's the proof outline for vNM representation?",
      "answer": "1. Define elementary lotteries e1 (worst) and eS (best) - completeness\n2. For any outcome xs, find Î±s where xs ~ Î±sÂ·eS + (1-Î±s)Â·e1 - continuity\n3. Define u(xs) = Î±s, so utility IS the mixing weight - independence\n4. L* â‰» L âŸº Î£ps*us > Î£ps'us - dominance"
    },
    {
      "blockType": "contrast",
      "question": "Cardinal vs ordinal utility?",
      "answer": "Ordinal: only ranking matters, any monotonic transform equivalent. Cardinal: magnitudes matter, only positive affine transforms (aÂ·u + b) preserve lottery preferences."
    },
    {
      "blockType": "why",
      "question": "Why does continuity matter for vNM?",
      "answer": "Continuity ensures there's always some probability mix making you indifferent between any two lotteries. Without it, you'd have lexicographic preferences that can't be represented numerically."
    }
  ],
  "sourceType": "topic",
  "sourceId": "22cfd720-4dae-4322-b69e-c13c2cd6a990"
}
```

---

## Part 7: Testing Strategy

1. **Unit tests**: Mock LLM, verify Learning structure
2. **Integration tests**: Extract from real topics, verify blocks populated
3. **E2E tests**: Full flow from PDF â†’ Topic â†’ Learning â†’ API â†’ UI
4. **Manual QA**: Review extraction quality before scaling

---

## Part 8: NOT in V1 (Future)

- Spaced repetition algorithm (SM-2)
- Per-card difficulty tracking in DB
- Auto-generated synthesis questions
- Study streaks / gamification
- LaTeX rendering (just use Unicode for now)

---

## Success Criteria

1. `yarn extract-learnings-from-topics --pdf-id <id>` produces rich learnings
2. Learnings have 5-15 blocks each
3. Flashcard UI shows interleaved session with rating buttons
4. Session complete screen shows synthesis prompt
5. Both conversation and topic sources work in unified system
